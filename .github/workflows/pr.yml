name: PR Check

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # Explicitly enable server prep to ensure JAR is downloaded for tests
          SKIP_PREPARE_SERVER: false

      - name: Validate code quality
        run: |
          npm run lint
          npm run check-types
          npm run compile
          /usr/bin/Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &
          export DISPLAY=:99
          npm run test:all

      - name: Check bundle size
        run: |
          if [ -f "client/out/extension.js" ]; then
            size=$(stat -c%s client/out/extension.js 2>/dev/null || stat -f%z client/out/extension.js)
            echo "Bundle size: $size bytes"
            if [ $size -gt 2000000 ]; then
              echo "❌ Bundle too large (>2MB)"
              exit 1
            fi
            echo "✅ Bundle size OK"
          else
            echo "❌ Extension bundle not found"
            exit 1
          fi
