name: Nightly Build

on:
  schedule:
    - cron: "0 3 * * *"
  workflow_dispatch:
    inputs:
      ref:
        description: "Ref to build from"
        required: false
        default: "main"
      use_latest_lsp:
        description: "Use the latest Groovy LSP (instead of pinned)"
        required: false
        type: boolean
        default: false
      skip_tests:
        description: "Skip test suite"
        required: false
        type: boolean
        default: false
      publish_prerelease:
        description: "Publish a GitHub prerelease with the nightly VSIX attached"
        required: false
        type: boolean
        default: false

jobs:
  nightly:
    runs-on: ubuntu-latest
    env:
      REQUIRE_SERVER_BUNDLE: true
      USE_LATEST_LSP_INPUT: ${{ github.event.inputs.use_latest_lsp || 'false' }}
      SKIP_TESTS_INPUT: ${{ github.event.inputs.skip_tests || 'false' }}
      PUBLISH_PRERELEASE_INPUT: ${{ github.event.inputs.publish_prerelease || 'false' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.inputs.ref || 'main' }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Setup Java
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: 17

      - name: Compute Groovy LSP cache key
        id: groovy_lsp_cache
        if: env.USE_LATEST_LSP_INPUT != 'true'
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          node tools/compute-groovy-cache-key.js >> "$GITHUB_OUTPUT"

      - name: Cache Groovy LSP
        if: env.USE_LATEST_LSP_INPUT != 'true'
        uses: actions/cache@v4
        with:
          path: |
            server/groovy-lsp.jar
            server/.groovy-lsp-version
          key: groovy-lsp-${{ runner.os }}-${{ steps.groovy_lsp_cache.outputs.tag }}-${{ steps.groovy_lsp_cache.outputs.hash }}

      - name: Install dependencies
        run: npm ci
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SKIP_PREPARE_SERVER: false
          USE_LATEST_GROOVY_LSP: ${{ env.USE_LATEST_LSP_INPUT }}

      - name: Compute nightly version
        id: nightly_version
        shell: bash
        run: |
          set -euo pipefail
          BASE_VERSION=$(node -p "require('./package.json').version.split('-')[0]")
          NIGHTLY_VERSION="${BASE_VERSION}-nightly.$(date -u +%Y%m%d%H%M)"
          npm version "$NIGHTLY_VERSION" --no-git-tag-version
          echo "nightly_version=$NIGHTLY_VERSION" >> "$GITHUB_OUTPUT"
          echo "nightly_tag=nightly-${NIGHTLY_VERSION}-${GITHUB_RUN_ID}" >> "$GITHUB_OUTPUT"

      - name: Build extension
        run: npm run compile

      - name: Run tests
        if: env.SKIP_TESTS_INPUT != 'true'
        run: npm test

      - name: Package VSIX
        run: npm run package
        env:
          SKIP_PREPARE_SERVER: true

      - name: Upload VSIX artifact
        uses: actions/upload-artifact@v5
        with:
          name: vsix-nightly-${{ steps.nightly_version.outputs.nightly_version }}
          path: "*.vsix"
          retention-days: 7

      - name: Publish prerelease (GitHub only)
        if: env.PUBLISH_PRERELEASE_INPUT == 'true'
        uses: softprops/action-gh-release@5be0e66d93ac7ed76da52eca8bb058f665c3a5fe # v2
        with:
          tag_name: ${{ steps.nightly_version.outputs.nightly_tag }}
          name: Nightly ${{ steps.nightly_version.outputs.nightly_version }}
          prerelease: true
          generate_release_notes: false
          files: "*.vsix"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
